name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-linux:
    name: Test linux/amd64 (race)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
          cache: true

      - name: Verify formatting
        run: |
          set -euo pipefail
          fmt_out=$(gofmt -s -l .)
          if [ -n "$fmt_out" ]; then
            echo "gofmt found issues:"
            echo "$fmt_out"
            exit 1
          fi

      - name: Vet
        run: go vet ./...

      - name: Test (race)
        run: go test ./... -race -count=1

  coverage-linux-amd64:
    name: Coverage linux/amd64 (public pkgs 100%)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
          cache: true

      - name: Test with coverage (exclude internal/*)
        run: |
          set -euo pipefail
          pkgs=$(go list ./... | grep -v '/internal/')
          coverpkgs=$(echo "$pkgs" | paste -sd, -)
          go test $pkgs -race -covermode=atomic -coverpkg="$coverpkgs" -coverprofile=coverage-amd64.out -count=1

      - name: Enforce 100% coverage (public pkgs)
        run: |
          set -euo pipefail
          total=$(go tool cover -func=coverage-amd64.out | tail -n1 | awk '{print $3}')
          echo "Total coverage (excluding internal/*): $total"
          if [ "$total" != "100.0%" ]; then
            echo "Coverage requirement not met (need 100.0%)"
            exit 1
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage-amd64.out
          flags: spin-linux-amd64
          name: spin
          fail_ci_if_error: true

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-linux-amd64
          path: coverage-amd64.out

  cross-test-compile:
    name: Cross test-compile (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: linux
            goarch: 386
          - goos: linux
            goarch: arm
          - goos: linux
            goarch: ppc64le
          - goos: linux
            goarch: s390x
          - goos: linux
            goarch: riscv64
          - goos: linux
            goarch: loong64
          - goos: linux
            goarch: mips64le
          - goos: js
            goarch: wasm
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
          cache: true

      - name: Cross compile (packages + tests, no execution)
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "0"
        run: |
          set -euo pipefail
          go env GOOS GOARCH

          go build ./...

          pkgs=$(go list ./...)
          mkdir -p ./.ci/testbins
          i=0
          for p in $pkgs; do
            i=$((i+1))
            out="./.ci/testbins/testbin_${i}"
            if [ "${GOOS}/${GOARCH}" = "js/wasm" ]; then
              out="${out}.wasm"
            fi
            go test -c -o "$out" "$p"
          done
